<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>SimpleES</title>

        <link href="https://simple-es.github.io/css/bootstrap.min.css" rel="stylesheet" type="text/css">
        <link href="https://simple-es.github.io/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href="https://simple-es.github.io/css/highlight.github.css" rel="stylesheet" type="text/css">
        <link href="https://simple-es.github.io/css/main.css" rel="stylesheet" type="text/css">
    </head>
    <body>

        <header class="navbar navbar-default navbar-fixed-top">

            <a class="navbar-brand" href="https://simple-es.github.io/">
                SimpleES
                <small class="hidden-xs hidden-sm">
                    A collection of &quot;simple&quot; Event Sourcing libraries for PHP
                </small>
            </a>

                            <a href="https://github.com/simple-es/event-sourcing">
                    <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png">
                </a>
            
        </header>

        <main class="container-fluid">
            <div class="row">

                
                    <nav id="sidebar" class="col-sm-3 col-lg-2" role="navigation">

                        <ul class="nav nav-pills nav-stacked">
                                                            <li class="">
                                    <a href="https://simple-es.github.io/">
                                        Home
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://simple-es.github.io/event-sourcing/events">
                                        Events
                                    </a>
                                </li>
                                                            <li class="active">
                                    <a href="https://simple-es.github.io/event-sourcing/aggregates">
                                        Aggregates
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://simple-es.github.io/event-sourcing/aggregate-manager">
                                        Aggregate Manager
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://simple-es.github.io/event-sourcing/event-store">
                                        Event Store
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://simple-es.github.io/doctrine-dbal-bridge">
                                        Doctrine DBAL Bridge
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://simple-es.github.io/jms-serializer-bridge">
                                        JMS Serializer Bridge
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://simple-es.github.io/message-bus-bridge">
                                        MessageBus Bridge
                                    </a>
                                </li>
                                                            <li class="">
                                    <a href="https://simple-es.github.io/ramsey-uuid-bridge">
                                        Ramsey UUID Bridge
                                    </a>
                                </li>
                                                    </ul>

                    </nav>

                
                <section id="content" class="col-sm-offset-3 col-lg-offset-2 col-sm-9 col-lg-10">
                    <h1>Aggregates</h1>
<p>Remember that with Event Sourcing an aggregate does not contain the state as we need it in the front-end of our application.
So our basket is not going to contain a list of products that were added to it.
In stead we are going keep track of events; that a basket was picked up and products were added to it.</p>
<p>This doesn't mean that an aggregate doesn't contain any state at all.
We need to know which basket we're dealing with, so we keep track of its identifier.</p>
<p>And we need the minimum amount of state to be able to protect invariants / enforce business rules.
To show this, we need a business rule.</p>
<p><em>The basket cannot contain more than 3 products.</em></p>
<p>In the real world we probably don't want to enforce this limit, but for the sake of this demonstration we will.
So we'll need to keep track of the number of products that were added. Without that number, we cannot determine if the limit is reached.</p>
<h3>Basket</h3>
<p>Let me present the entire basket aggregate:</p>
<pre><code class="language-php">use SimpleES\EventSourcing\Aggregate\EventTrackingCapabilities;
use SimpleES\EventSourcing\Aggregate\TracksEvents;
use SimpleES\EventSourcing\Event\AggregateHistory;

final class Basket implements TracksEvents
{
    use EventTrackingCapabilities;

    /** @var BasketId */
    private $basketId;

    /** @var int */
    private $productCount;

    /**
     * @param BasketId $basketId
     * @return Basket
     */
    public static function pickUp(BasketId $basketId)
    {
        $basket = new Basket();
        $basket-&gt;recordThat(new BasketWasPickedUp($basketId));

        return $basket;
    }

    /** @param ProductId $productId */
    public function addProduct(ProductId $productId)
    {
        $this-&gt;guardProductLimit();

        $this-&gt;recordThat(new ProductWasAddedToBasket($this-&gt;basketId, $productId));
    }

    /** @return BasketId */
    public function basketId()
    {
        return $this-&gt;basketId;
    }

    /** @param BasketWasPickedUp $event */
    private function whenBasketWasPickedUp(BasketWasPickedUp $event)
    {
        $this-&gt;basketId     = $event-&gt;basketId();
        $this-&gt;productCount = 0;
    }

    /** @param ProductWasAddedToBasket $event */
    private function whenProductWasAddedToBasket(ProductWasAddedToBasket $event)
    {
        $this-&gt;productCount++;
    }

    /** @throws BasketLimitReached */
    private function guardProductLimit()
    {
        if ($this-&gt;productCount == 3) {
            throw new \OverflowException('Limit of 3 products exceeded');
        }
    }
}</code></pre>
<p>Now let's go over some details.</p>
<h3>Basket was picked up</h3>
<pre><code class="language-php">    /**
     * @param BasketId $basketId
     * @return Basket
     */
    public static function pickUp(BasketId $basketId)
    {
        $basket = new Basket();
        $basket-&gt;recordThat(new BasketWasPickedUp($basketId));

        return $basket;
    }</code></pre>
<p>With this static factory method we instantiate the basket and record the event of picking up the basket.
<code>recordThat(DomainEvent $event)</code> is a method that will take care of recording and applying the event.</p>
<p>Applying the event means protecting the invariants and changing the state if needed.
It's important that this happens separately from recording the event!</p>
<p>Recorded events are to be stored in an event store.
When we later fetch those events and replay them to get our aggregate back, we need to apply them again <em>without</em> getting recorded.
Otherwise they are stored again and we've effectively duplicated all the events.</p>
<p>The <code>recordThat(DomainEvent $event)</code> (provided by the <code>EventTrackingCapabilities</code> trait) will search for a method with the same name as the event preceded by &quot;when&quot;.
In other words, for the event <code>ProductWasAddedToBasket</code> the method <code>whenProductWasAddedToBasket</code> is searched for.
If the method exists, it will be called with the event as argument.</p>
<pre><code class="language-php">    /** @param BasketWasPickedUp $event */
    private function whenBasketWasPickedUp(BasketWasPickedUp $event)
    {
        $this-&gt;basketId     = $event-&gt;basketId();
        $this-&gt;productCount = 0;
    }</code></pre>
<p>This will set the identifier of the basket and set the current product count to zero.</p>
<h3>Product was added to basket</h3>
<pre><code class="language-php">    /**
     * @param ProductId $productId
     */
    public function addProduct(ProductId $productId)
    {
        $this-&gt;guardProductLimit();

        $this-&gt;recordThat(new ProductWasAddedToBasket($this-&gt;basketId, $productId));
    }

    /** @throws BasketLimitReached */
    private function guardProductLimit()
    {
        if ($this-&gt;productCount == 3) {
            throw new \OverflowException('Limit of 3 products exceeded');
        }
    }</code></pre>
<p>The first thing we do when a product is added to the basket is check the product limit.
If the basket already contains 3 products, an exception is thrown.
This way we enforce our business rule.</p>
<p>Next we record the event.</p>
<p>But how does the current product count ever reach 3?</p>
<pre><code class="language-php">    /** @param ProductWasAddedToBasket $event */
    private function whenProductWasAddedToBasket(ProductWasAddedToBasket $event)
    {
        $this-&gt;productCount++;
    }</code></pre>
<p>By applying the event of course! Whenever a product is added, we increase the product count.</p>
<h2>Internals</h2>
<p>Coming soon...</p>
                </section>

            </div>
        </main>

        <footer>
            <div class="container-fluid">
                <p class="text-muted">
                    website generated with <a href="http://couscous.io" title="Markdown website generator">Couscous</a>
                </p>
            </div>
        </footer>

        <script src="https://simple-es.github.io/js/jquery.min.js" type="text/javascript"></script>
        <script src="https://simple-es.github.io/js/bootstrap.min.js" type="text/javascript"></script>
        <script src="https://simple-es.github.io/js/highlight.min.js" type="text/javascript"></script>

        <script>
            $(function() {
                $("section>h1").wrap('<div class="page-header" />');
                // Syntax highlighting
                hljs.initHighlightingOnLoad();
            });
        </script>

    </body>
</html>
